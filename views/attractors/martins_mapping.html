<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Martins Mapping</title>
    <script src="https://code.jquery.com/jquery-2.0.0.min.js"></script>
    <link href="../../css/main.css" type="text/css" rel="stylesheet"/>
</head>
<body id="fractal_body">
<canvas id="canvas"></canvas>
<form>
    <div>
        <label for="speedInput">Speed</label>
        <input class="slider" type="range" min="1" max="3000" id="speedInput" value="1000"/>
    </div>
    <div>
        <label for="colorInput">Color</label>
        <input type="color" id="colorInput" value="#00ff00"/>
    </div>
    <div>
        <label for="backgroundColorInput">Background color</label>
        <input type="color" id="backgroundColorInput" value="#000000"/>
    </div>
    <div>
        <label for="aInput">A: <span id="aValue">-1.4</span></label>
        <input class="slider" type="range" min="-3" max="2" id="aInput" value="-1.4" step="0.001"/>
    </div>
    <div>
        <label for="bInput">B: <span id="bValue">1.6</span></label>
        <input class="slider" type="range" min="-2" max="2" id="bInput" value="1.6" step="0.001"/>
    </div>
    <div>
        <label for="cInput">C: <span id="cValue">1.0</span></label>
        <input class="slider" type="range" min="-2" max="2" id="cInput" value="1.0" step="0.001"/>
    </div>
    <div>
        <label for="dInput">D: <span id="dValue">1.0</span></label>
        <input class="slider" type="range" min="1" max="2" id="dInput" value="1.0" step="0.001"/>
    </div>
    <div>
        <label for="pInput">P: <span id="pValue">0.5</span></label>
        <input class="slider" type="range" min="-2" max="2" id="pInput" value="0.7" step="0.001"/>
    </div>
    <div>
        <label for="opacityInput">Intensity: <span id="opacityValue">0.05</span></label>
        <input class="slider" type="range" min="0.01" max="1" id="opacityInput" value="0.05" step="0.01"/>
    </div>
    <div>
        <label for="examples">Examples</label>
        <select name="examples" id="examples">
        </select>
    </div>
    <div>
        <button id="clearButton">Clear</button>
    </div>
    <div>
        <button id="stopButton">Stop</button>
    </div>
    <div>
        <p>x<sub>n+1</sub> = y<sub>n</sub> - sgn(x<sub>n</sub>) * |b*x<sub>n</sub>-c|<sup>(p/d)</sup></p>
        <p>y<sub>n+1</sub> = a - x<sub>n</sub></p>
    </div>
    <hr>
    <div>
        <p>x<sub>n+1</sub> = y<sub>n</sub> - sgn(x<sub>n</sub>) * |<span class="bVar"></span>*x<sub>n</sub>-<span class="cVar"></span>|<sup>(<span class="pVar"></span>/<span class="dVar"></span>)</sup></p>
        <p>y<sub>n+1</sub> = <span class="aVar"></span> - x<sub>n</sub></p>
    </div>
    <div>
        <a href="index.html">Menu</a>
    </div>
</form>
</body>
<script>
    jQuery(document).ready(function () {
        var sizeX;
        var sizeY;
        var centerX;
        var centerY;
        var scale;
        var x;
        var y;
        var a;
        var b;
        var c;
        var d;
        var p;
        var speed;
        var color;
        var backgroundColor;
        var stop;
        var pixels;
        var percent;
        var canvas;
        var ctx;
        var examples;
        var opacity;

        init();

        function init() {
            prepareVariables();
            setSliders();
            prepareEvents();
            clearPixelsArray();
            requestAnimationFrame(draw);
        }

        function prepareVariables() {
            sizeX = $("#canvas").width();
            sizeX -= $("form").width();
            $("#canvas").width(sizeX);
            sizeY = $("#canvas").height();
            centerX = sizeX / 2;
            centerY = sizeY / 2;
            scale = 5;
            x = 0;
            y = 0;
            speed = 1000;
            color = 0x00ff00;
            backgroundColor = "#000000";
            stop = false;
            pixels = [];
            percent = 5 / 100;
            a = -2.7;
            b = 0.6;
            c = -1.0;
            d = 1.0;
            p = 0.5;
            opacity = 0.05;
            examples = [];
            prepareExamples();
            prepareCanvas();
        }

        function setSliders() {
            setSlidersValues();
            setSlidersLabelsValues();
            setFormulaVariables();
        }

        function setSlidersValues() {
            $("#aInput").val(a);
            $("#bInput").val(b);
            $("#cInput").val(c);
            $("#dInput").val(d);
            $("#pInput").val(p);
            $("#opacityInput").val(opacity);
        }

        function setSlidersLabelsValues() {
            $("#aValue").html(a);
            $("#bValue").html(b);
            $("#cValue").html(c);
            $("#dValue").html(d);
            $("#pValue").html(p);
            $("#opacityValue").html(opacity);
        }

        function setFormulaVariables() {
            $(".aVar").html(a);
            $(".bVar").html(b);
            $(".cVar").html(c);
            $(".dVar").html(d);
            $(".pVar").html(p);
        }

        function prepareEvents() {
            $("#speedInput").change(function () {
                speed = $("#speedInput").val();
            });

            $("#colorInput").change(function () {
                var tmp = $("#colorInput").val();
                tmp = tmp.replace("#", "");
                tmp = parseInt(tmp, 16);
                color = tmp;
            });

            $("#backgroundColorInput").change(function () {
                backgroundColor = $("#backgroundColorInput").val();
                clearPixelsArray();
                ctx.fillStyle = backgroundColor;
                ctx.fillRect(0, 0, sizeX, sizeY);
            });

            $("#aInput").bind('input', function () {
                a = $("#aInput").val();
                $("#aValue").html(a);
                $(".aVar").html(a);
            });

            $("#bInput").bind('input', function () {
                b = $("#bInput").val();
                $("#bValue").html(b);
                $(".bVar").html(b);
            });

            $("#cInput").bind('input', function () {
                c = $("#cInput").val();
                $("#cValue").html(c);
                $(".cVar").html(c);
            });

            $("#dInput").bind('input', function () {
                d = $("#dInput").val();
                $("#dValue").html(d);
                $(".dVar").html(d);
            });

            $("#pInput").bind('input', function () {
                p = $("#pInput").val();
                $("#pValue").html(p);
                $(".pVar").html(p);
            });

            $("#opacityInput").bind('input', function () {
                opacity = $("#opacityInput").val();
                $("#opacityValue").html(opacity);
            });

            $("#clearButton").click(function () {
                clearPixelsArray();

                ctx.fillStyle = backgroundColor;
                ctx.fillRect(0, 0, sizeX, sizeY);
                x = 0;
                y = 0;
                return false;
            });

            $("#stopButton").click(function () {
                stop = !stop;

                if (stop) {
                    $("#stopButton").html("Start");
                } else {
                    $("#stopButton").html("Stop");
                }
                return false;
            });

            $("#examples").change(function () {
                var selectedIndex = $('select[name=examples]').val();
                if (selectedIndex == -1) {
                    return;
                }

                var selectedExample = examples[selectedIndex];
                a = selectedExample.A;
                b = selectedExample.B;
                c = selectedExample.C;
                d = selectedExample.D;
                p = selectedExample.P;
                opacity = selectedExample.opacity;
                setSlidersValues();
                setSlidersLabelsValues();
                setFormulaVariables();
            });
        }

        function clearPixelsArray() {
            for (var i = 0; i <= sizeX; ++i) {
                pixels[i] = [];
                for (var j = 0; j <= sizeY; ++j) {
                    pixels[i][j] = 0;
                }
            }
        }

        function prepareCanvas() {
            canvas = document.getElementById("canvas");
            canvas.width = sizeX;
            canvas.height = sizeY;
            ctx = canvas.getContext("2d");
            ctx.fillStyle = backgroundColor;
            ctx.fillRect(0,0, sizeX, sizeY);
        }

        function sgn(a) {
            if (a < 0) {
                return -1;
            } else {
                return 1;
            }
        }

        function draw() {
            requestAnimationFrame(draw);
            if (stop) {
                return;
            }

            var xn, yn;

            for (var i = 0; i < speed; ++i) {
                xn = y - sgn(x) * Math.pow((Math.abs(b*x-c)), p/d);
                yn = a - x;
                x = xn;
                y = yn;

                var cx = Math.round(centerX + x * scale), cy = Math.round(centerY + y * scale);
                if(cx < 0 || cy < 0 || cx > sizeX || cy > sizeY) {
                    continue;
                }

                var val = pixels[cx][cy];
                var rgb = hex2rgb(color);
                rgb[0] -= rgb[0] * val * percent > 0 ? rgb[0] * val * percent : 0;
                rgb[1] -= rgb[1] * val * percent > 0 ? rgb[1] * val * percent : 0;
                rgb[2] -= rgb[2] * val * percent > 0 ? rgb[2] * val * percent : 0;

                ctx.fillStyle = "rgba(" + rgb[0] * 255 + "," + rgb[1] * 255 + "," + rgb[2] * 255 + "," + opacity + ")";
                ctx.fillRect(cx, cy, 1, 1);

                pixels[cx][cy] = pixels[cx][cy] < 20 ? pixels[cx][cy] + 1 : 0;
            }
        }

        function hex2rgb(hex) {
            var rgb = [];
            rgb[0] = (hex >> 16 & 255) / 255;
            rgb[1] = (hex >> 8 & 255) / 255;
            rgb[2] = (255 & hex) / 255;
            return rgb;
        }

        function prepareExamples() {
            examples[0] = {
                name: "1",
                A: -2.7,
                B: 0.6,
                C: -1.0,
                D: 1.0,
                P: 0.5,
                opacity: 0.05
            };
            examples[1] = {
                name: "2",
                A: -2.6,
                B: 0.6,
                C: -1.0,
                D: 1.0,
                P: 0.5,
                opacity: 0.05
            };
            examples[2] = {
                name: "3",
                A: -2.75,
                B: 0.6,
                C: -1.0,
                D: 1.0,
                P: 0.5,
                opacity: 0.05
            };
            examples[3] = {
                name: "4",
                A: -2.62,
                B: 0.6,
                C: -1.0,
                D: 1.0,
                P: 0.5,
                opacity: 0.05
            };
            examples[4] = {
                name: "5",
                A: -2.751,
                B: 0.6,
                C: -1.0,
                D: 1.0,
                P: 0.5,
                opacity: 0.05
            };
            examples[5] = {
                name: "6",
                A: -2.6,
                B: 0.7,
                C: -1.0,
                D: 1.0,
                P: 0.5,
                opacity: 0.05
            };
            examples[6] = {
                name: "7",
                A: -2.6,
                B: 0.75,
                C: -1.0,
                D: 1.0,
                P: 0.5,
                opacity: 0.05
            };
            examples[7] = {
                name: "8",
                A: -2.6,
                B: 0.76,
                C: -1.0,
                D: 1.0,
                P: 0.5,
                opacity: 0.05
            };
            examples[8] = {
                name: "9",
                A: -2.6,
                B: 0.761,
                C: -1.0,
                D: 1.0,
                P: 0.5,
                opacity: 0.05
            };
            examples[9] = {
                name: "10",
                A: -2.6,
                B: 0.6,
                C: -1.0,
                D: 1.2,
                P: 0.5,
                opacity: 0.05
            };
            examples[10] = {
                name: "11",
                A: -2.6,
                B: 0.6,
                C: -1.0,
                D: 1.22,
                P: 0.5,
                opacity: 0.05
            };
            examples[11] = {
                name: "12",
                A: -2.6,
                B: 0.6,
                C: -0.9,
                D: 1.0,
                P: 0.5,
                opacity: 0.05
            };
            examples[12] = {
                name: "13",
                A: -2.6,
                B: 0.6,
                C: -0.85,
                D: 1.0,
                P: 0.5,
                opacity: 0.05
            };
            examples[13] = {
                name: "14",
                A: -2.6,
                B: 0.6,
                C: 0.84,
                D: 1.0,
                P: 0.5,
                opacity: 0.05
            };
            examples[14] = {
                name: "15",
                A: -2.6,
                B: 0.6,
                C: -1.0,
                D: 1.0,
                P: 0.6,
                opacity: 0.05
            };
            examples[15] = {
                name: "16",
                A: -2.6,
                B: 0.6,
                C: -1.0,
                D: 1.0,
                P: 0.65,
                opacity: 0.05
            };
            examples[16] = {
                name: "17",
                A: -2.6,
                B: 0.6,
                C: -1.0,
                D: 1.0,
                P: 0.651,
                opacity: 0.05
            };
            examples[17] = {
                name: "18",
                A: -1.796,
                B: 1.204,
                C: -0.785,
                D: 1.225,
                P: 1,
                opacity: 0.05
            };
            examples[18] = {
                name: "19",
                A: -2.372,
                B: 0.901,
                C: 1.518,
                D: 1.812,
                P: 1,
                opacity: 0.05
            };

            for (var i = 0; i < examples.length; ++i) {
                $("#examples").append("<option value='" + i + "'>" + examples[i].name + "</option>");
            }
        }
    });
</script>
</html>
