<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Magnetic Particles</title>
    <script>if (typeof module === 'object') {window.module = module; module = undefined;}</script>
    <script src="../../node_modules/jquery/dist/jquery.min.js"></script>
    <script src="../../js/point.js"></script>
    <script src="../../js/rectangle.js"></script>
    <script src="../../js/particle.js"></script>
    <script>if (window.module) module = window.module;</script>
    <link href="../../css/main.css" type="text/css" rel="stylesheet"/>
</head>
<body id="fractal_body">
<canvas id="canvas"></canvas>
<form>
    <div>
        <label for="speedInput">Speed</label>
        <input class="slider" type="range" min="1" max="300" id="speedInput" value="10"/>
    </div>
    <div>
        <label for="lengthInput">Length</label>
        <input class="slider" type="range" min="1" max="100" id="lengthInput" value="10"/>
    </div>
    <div>
        <label for="colorInput">Color</label>
        <input type="color" id="colorInput" value="#00ff00"/>
    </div>
    <div>
        <label for="opacityInput">Intensity: <span id="opacityValue">0.05</span></label>
        <input class="slider" type="range" min="0.01" max="1" id="opacityInput" value="0.05" step="0.01"/>
    </div>
    <div>
        <button id="clearButton">Clear</button>
    </div>
    <div>
        <a href="index.html">Menu</a>
    </div>
</form>
</body>
<script>
    jQuery(document).ready(function () {
        let sizeX;
        let sizeY;
        let centerX;
        let centerY;
        let speed;
        let canvas;
        let ctx;
        let $canvas;
        let particles;

        init();

        function init() {
            prepareVariables();
            requestAnimationFrame(animate);
        }

        function prepareVariables() {
            $canvas = $("#canvas");
            sizeX = $canvas.width();
            sizeX -= $("form").width();
            $canvas.width(sizeX);
            sizeY = $canvas.height();
            centerX = sizeX / 2;
            centerY = sizeY / 2;

            prepareCanvas();
            prepareParticles();
        }

        function prepareCanvas() {
            canvas = document.getElementById("canvas");
            canvas.width = sizeX;
            canvas.height = sizeY;
            ctx = canvas.getContext("2d");
            ctx.fillStyle = "#fff";
            ctx.fillRect(0, 0, sizeX, sizeY);
        }

        function prepareParticles() {
            particles = [];
            for(let i = 0; i < 10; ++i) {
                let particle = new Particle(new Rectangle(0, 0, sizeX, sizeY));
                particles.push(particle);
            }
        }

        function animate() {
            requestAnimationFrame(animate);
            resetForces();
            updateForces();
            updateParticles();
            containParticles();
            draw();
        }

        function resetForces() {
            for(let i = 0; i < particles.length; ++i) {
                particles[i].resetForce();
            }
        }

        function updateForces() {
            for(let i = 0; i < particles.length; ++i) {
                for(let j = i + 1; j < particles.length; ++j) {
                    let difference = Point.difference(particles[j].location, particles[i].location);
                    let distance = Point.distance(particles[j].location, particles[i].location);

                    if(distance === 0) {
                        continue;
                    }

                    let forceVal = -1 * particles[i].charge * particles[j].charge / (distance * distance);
                    forceVal = Math.min(forceVal, 1000);
                    let force = new Point(forceVal * difference.x / distance, forceVal * difference.y / distance);
                    particles[i].force.add(force);
                    particles[j].force.substract(force);
                }
            }
        }

        function updateParticles() {
            for(let i = 0; i < particles.length; ++i) {
                particles[i].applyForce();
                particles[i].move();
            }
        }

        function containParticles() {
            for(let i = 0; i < particles.length; ++i) {
                particles[i].bounce(new Rectangle(0, 0, sizeX, sizeY));
            }
        }

        function draw() {
            ctx.fillStyle = "#fff";
            ctx.fillRect(0, 0, sizeX, sizeY);
            for(let i=0; i < particles.length; ++i) {
                particles[i].draw(ctx);
            }
        }
    });
</script>
</html>
